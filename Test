#!/bin/bash

# Define the OpenShift cluster URLs and corresponding namespaces
declare -A CLUSTERS
CLUSTERS["https://cluster1.openshift.com:8443"]="namespace1 namespace2"
CLUSTERS["https://cluster2.openshift.com:8443"]="namespace3 namespace4"

# Define tokens for each cluster (replace with your actual tokens)
declare -A TOKENS
TOKENS["https://cluster1.openshift.com:8443"]="your-cluster1-token"
TOKENS["https://cluster2.openshift.com:8443"]="your-cluster2-token"

# Define the label selector (replace with your actual label selector)
LABEL_SELECTOR="your-label-key=your-label-value"

# Function to parse pod names from JSON
parse_pod_names() {
    local json=$1
    local pod_names=()

    while read -r line; do
        if [[ $line =~ \"name\":\"([^\"]+)\" ]]; then
            pod_names+=("${BASH_REMATCH[1]}")
        fi
    done < <(echo "$json" | tr ',' '\n')

    echo "${pod_names[@]}"
}

# Loop through each cluster
for CLUSTER_URL in "${!CLUSTERS[@]}"; do
    echo "Processing cluster: $CLUSTER_URL"
    TOKEN=${TOKENS[$CLUSTER_URL]}
    
    # Get the namespaces for the current cluster
    NAMESPACES=${CLUSTERS[$CLUSTER_URL]}
    
    # Loop through each namespace in the current cluster
    for NAMESPACE in $NAMESPACES; do
        echo "Fetching pods for namespace: $NAMESPACE in cluster: $CLUSTER_URL"
        
        # Get the list of pods in the current namespace with the specific label
        API_URL="$CLUSTER_URL/api/v1/namespaces/$NAMESPACE/pods?labelSelector=$LABEL_SELECTOR"
        PODS_JSON=$(curl -H "Authorization: Bearer $TOKEN" -k $API_URL)
        
        # Extract pod names using the parse_pod_names function
        POD_NAMES=$(parse_pod_names "$PODS_JSON")
        
        # Loop through each pod and fetch logs
        for POD in $POD_NAMES; do
            LOG_URL="$CLUSTER_URL/api/v1/namespaces/$NAMESPACE/pods/$POD/log"
            echo "Logs for pod: $POD in namespace: $NAMESPACE on cluster: $CLUSTER_URL"
            LOGS=$(curl -H "Authorization: Bearer $TOKEN" -k $LOG_URL)
            LOG_FILE="${CLUSTER_URL//[:\/]/_}_${NAMESPACE}_${POD}.log"
            echo "$LOGS" > $LOG_FILE
            echo "Logs saved to $LOG_FILE"
        done
    done
done
